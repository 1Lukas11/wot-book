<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My first WoT Mashup!</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</head>

<body>
<script type="text/javascript">
$(document).ready(function () {
    var gatewayRootUrl = "http://devices.webofthings.cc/";
    var camRootUrl = "http://devices.webofthings.cc/camera/";
    var piRootUrl = "http://devices.webofthings.cc/pi/";

    function mashup(name, location) {//#A
        $.getJSON(prepareYahooWeatherUrl(location), function (yahooResult) {
            var localTemp = yahooResult.query.results.channel.item.condition.temp;
            console.log('Local @ ' + location + ': ' + localTemp);
            $.getJSON(piRootUrl + 'sensors/temperature', function (piResult) {//#B
                var piTemp = piResult.value;
                console.log('Pi @ London: ' + piTemp);
                publishMessage(prepareMessage(name, location, localTemp, piTemp)); //#C
            });
        });
    }


    function publishMessage(message) {
        var payload = {"value": message};
        $.ajax(piRootUrl + 'actuators/display/content', {
            data: JSON.stringify(payload),
            contentType: 'application/json',
            type: 'POST',
            success: function (data) {
                $('#message').html('Published: ' + message);
                console.log('Will take a picture in ' +
                data.displayInSeconds + ' seconds...');
                setTimeout(function () { //#D
                    takePicture();
                }, data.displayInSeconds+1); // +1 just in case ;)
            }
        });
    }
 
    function prepareYahooWeatherUrl(location) {
        return "https://query.yahooapis.com/v1/public/yql?q=select item from weather.forecast where woeid in (select woeid from geo.places(1) where text='" + location + "') and u='c'&format=json";
    }

    function prepareMessage(name, location, localTemp, piTemp) {
        var diff = localTemp - piTemp;
        var qualifier = ' higher ';
        if (diff < 0) {
            qualifier = ' lower ';
        }
        var result = 'Hello I\'m ' + name + ' from ' + location;
        result += ' my local temperature is ' + Math.abs(diff) + ' degrees';
        result += qualifier + 'than yours!';
        return result;
    }

    function takePicture() {
        $.ajax({
            type: 'GET',
            url: 'camRootUrl' + 'sensors/picture/',
            //datatype: 'image/jpg',  //get a JSON and parse it 
            dataType: 'application/json',
            success: function (data) {
                $('#camImg').attr('src', data.value);
            }
        });
    }
    mashup('Rachel', 'Zurich, Switzerland');
});
//#A this starts by getting the local temperature from Yahoo
//#B then it gets the remote temperature
//#C then we publish the message on the LCD screen
//#D we delay taking the picture until is is our turn, based on what the server told us to wait

// @DOM - can you please add a little more descriptions here (e.g. the quivalent of the text explanations?)

</script>

</body>
<h1>Compare my Weather WoT Mashup</h1>

<h2 id='message'></h2>
<img id="camImg" src=""/>
</html>