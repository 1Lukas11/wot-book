<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

  <script type="text/javascript">
  	var token = 'cKXRTaRylYWQiF3MICaKndG4WJMcVLFz';
    var modelUrl = 'http://localhost:8484/model?token='+token;
    var baseUrl;
    var longitude;
    var latitude;
  </script>

  <script type="text/javascript">

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
        console.log("Loading geolocation")
      } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function showPosition(position) {
      console.log(" You are here: ("+position.coords.latitude+","+position.coords.longitude+")");
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;
    }

	function getModel(sourceUrl){ 
	  $.ajax({ 
	      url: sourceUrl, //#A
		  dataType: "json",
		  headers: {Accept : "application/json"},
	      type: 'GET', //#B
	      success: function( data ){ //#D
	      	baseUrl=data.customFields.hostname+":"+"8484";         
	     	$('#wt-name').html(data.name);
	     	$('#wt-description').html(data.description);
	     	generateActions(data.links.actions.resources);
	     	generateProperties(data.links.properties.resources);
	      }, 
	      error: function( jqXhr, textStatus, errorThrown ){//#E 
	          console.log( errorThrown ); 
	      } 
	  });
	}

	function generateActions(actions){ 
		$.each(actions, function(i,item){ // For each action in the model, create a form
		    $("<h3>").html(item.name).appendTo("#wt-actions");
		    $("<p>").html(item.description).appendTo("#wt-actions");
		    $("<form>").attr("id","wt-actions-"+i).appendTo("#wt-actions");

			$.each(item.values, function(vi,vitem){ // Create a field for each input parameter
				$("<div>").attr("id","wt-actions-"+i+"-"+vi+"-field").appendTo("#wt-actions-"+i);
		    	$("<label>").html(vi).appendTo("#wt-actions-"+i+"-"+vi+"-field");
		    	// TODO: Generate dropdowns for booleans & enums
		    	// TODO: generate a slider for min-max integers
		    	$("<input>").attr("type","text").attr("name",vi).attr("value","("+vitem.type+")").attr("id","text").appendTo("#wt-actions-"+i+"-"+vi+"-field");
		    	//$("<span>") show required/option
			});


		    // Attach handler to the button
		    $("<p>").html("<a class=\"btn btn-primary btn-lg\" id=\"send-"+i+"\" href=\"#\" role=\"button\">Create Action: "+i+"</a>").appendTo("#wt-actions");
		    $('#send-'+i).click(function() {
		    	var data = {}; // # # Maps the fields of the form into the data input object 
		    	$("#wt-actions-"+i).serializeArray().map(function(x){data[x.name] = x.value;});
            	sendAction(i,data); // # # Sends the action to the Web Thing
            });

		});
	}

	function generateProperties(properties){ 
		// Loop over all resources
		$.each(properties, function(i,item){
			$("<h3>").html(item.name).appendTo("#wt-properties");
			$("<p>").html(item.description).appendTo("#wt-properties");
			$("<h5>").html("Values (timestamp: <span id=\"property-"+i+"-value-timestamp\">unknown</span>)").appendTo("#wt-properties");
			$("<ul>").attr("class","list-group").attr("id","property-"+i).appendTo("#wt-properties");

			$.each(item.values, function(vi,vitem){ //
		    	$("<li>").attr("class","list-group-item").html("<span id=\"property-"+i+"-value-"+vi+"\" class=\"badge\"></span>"+vi).appendTo("#property-"+i);
			});

			$.each(item.data, function(vi,vitem){ //
		    	$("property-"+i+"-value-"+vi).attr("class","list-group-item").html("<span id=\"property-"+i+"-value-"+vi+"\" class=\"badge\"></span>"+vi).appendTo("#property-"+i);
			});

			// Subscribe to the property via WebSocket
			var url = 'ws://'+baseUrl+'/properties/'+i;
			var socket = new WebSocket(url); //#A 

			socket.onopen = function (message) { //
			  console.log("Subscribed to Property : "+url); //
			};

			socket.onmessage = function (message) { //#B
				var content = JSON.parse(message.data);
				console.log("Property "+i+" updated : ", content); //#C
				$.each(content, function(vi,vitem){ // For each value we received, update it
					$("#property-"+i+"-value-"+vi).text(vitem); 
				});
			};

			socket.onerror = function (error) {
			    console.log('An error occurred while trying to connect to a WebSocket!');
			    console.log(error);
			};

		});

	}

    $(window).bind("load", function() {
		getModel(modelUrl);
		getLocation()
    });


  </script>

  <title>WoT Controller</title>

  <style class="anchorjs"></style><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.0/js/bootstrap-toggle.min.js"></script>

  <!-- Documentation extras -->
  <link href="./files/docs.min.css" rel="stylesheet">

</head>


  <body>

    <!-- Docs page layout -->
    <div class="bs-docs-header" id="content" tabindex="-1">
      <div class="container">
        <h1>WoT UI</h1>
        <p>Control any Web Thing!</p>
      </div>
    </div>

    <div class="container bs-docs-container">
      <div class="row">
        <div class="col-md-9" role="main">
          <div class="bs-docs-section">

            <h2 id="wt-name">Smart Plug</h2>
            <p id="wt-description"></p>

            <hr>
            <h2>Actions</h2>
            <div id="wt-actions">
            </div>


            <hr>
            <h2>Properties</h2>
            <div id="wt-properties">
            </div>


            <script>

			function sendAction(type,value){ 
			  $.ajax({ 
			      url: 'http://'+baseUrl+'/actions/'+type+'?token='+token,//#A
			      dataType: 'json', //#B
			      type: 'post', //#B
			      contentType: 'application/json', //#B
			      data: JSON.stringify(value),
			      //data: JSON.stringify({"type": type, "thng": thngId, "customFields":value,"location":{"position":{"type": "Point","coordinates": [longitude, latitude]}},"locationSource":"sensor"}), //#C
			      processData: false, 
			      success: function( data, textStatus, jQxhr ){ //#D
			      	console.log("Action sent: "+JSON.stringify( value ));	
			          //$('#response pre').html( JSON.stringify( data ) ); 
			      }, 
			      error: function( jqXhr, textStatus, errorThrown ){//#E 
			          console.log( errorThrown ); 
			      } 
			  });
			}
			//#A The custom actions endpoint in EVRYTHNG
			//#B We POST a JSON document
			//#C The payload to POST 
			//#D If successful, update the "response" html element
			//#E If an error, display in the console

            </script>

          </div>

          </div>
        </div>

    <!-- Footer
================================================== -->
<footer class="bs-docs-footer" role="contentinfo">
  <div class="container">

    <p>Built with the amazing D3, Bootstrap, and bootstraptoggle.</p>

  </div>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->




</body></html>